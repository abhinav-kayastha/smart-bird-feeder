<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Activity Monitor</h1>
  <p>Here you can monitor the activity of the Smart Bird Feeder.</p>
  <button onclick="window.location.href='/'">Home</button>
  <button onclick="window.location.href='/logs'">Logs</button>
  <h2 id="graphTitle">Graphs</h2>
  <div id="graphContainer">
    <canvas id="hourlyChart" width="400" height="200"></canvas>
    <canvas id="weeklyChart" width="400" height="200" style="display:none;"></canvas>
    <canvas id="monthlyChart" width="400" height="200" style="display:none;"></canvas>
    <canvas id="yearlyChart" width="400" height="200" style="display:none;"></canvas>
  </div>
  <div id="pagination">
    <button id="prevGraph" onclick="prevGraph()">Previous</button>
    <button id="nextGraph" onclick="nextGraph()">Next</button>
  </div>

  <script>
    let currentGraph = 0;
    const graphs = ['hourlyChart', 'weeklyChart', 'monthlyChart', 'yearlyChart'];
    const graphTitles = ['Hourly Activity Data', 'Weekly Activity Data', 'Daily Activity Data for Current Month', 'Monthly Activity Data'];

    let hourlyChart, weeklyChart, monthlyChart, yearlyChart;
    let hours = Array(24).fill(0);
    let days = Array(7).fill(0);
    let daily = Array(31).fill(0); // Assuming a maximum of 31 days in a month
    let months = Array(12).fill(0);

    async function fetchActivityData() {
      try {
        const response = await fetch('/sensor-data');
        const data = await response.json();
        const activityData = data.data;

        // Process data to get the number of entries per hour, day, month, and day of the current month
        hours = Array(24).fill(0);
        days = Array(7).fill(0);
        daily = Array(31).fill(0);
        months = Array(12).fill(0);

        activityData.forEach(item => {
          const [date, time] = item.timestamp.split(', ');
          const [day, month, year] = date.split('/');
          const hour = parseInt(time.split(':')[0], 10);

          // Update hourly data
          hours[hour]++;

          // Update daily data (assuming the first day of the week is Sunday)
          const dayOfWeek = new Date(`${year}-${month}-${day}`).getDay();
          days[dayOfWeek]++;

          // Update daily data for the current month
          if (parseInt(month, 10) === new Date().getMonth() + 1 && parseInt(year, 10) === new Date().getFullYear()) {
            daily[parseInt(day, 10) - 1]++;
          }

          // Update monthly data
          months[parseInt(month, 10) - 1]++;
        });

        // Create the charts
        createCharts();
      } catch (error) {
        console.error('Error fetching activity data:', error);
      }
    }

    function createCharts() {
      const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
      hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00 - ${i}:59`),
          datasets: [{
            label: 'Number of Data Entries',
            data: hours,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            x: {
              beginAtZero: true
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
      weeklyChart = new Chart(weeklyCtx, {
        type: 'bar',
        data: {
          labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
          datasets: [{
            label: 'Number of Data Entries',
            data: days,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            x: {
              beginAtZero: true
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: Array.from({ length: 31 }, (_, i) => `${i + 1}`),
          datasets: [{
            label: 'Number of Data Entries',
            data: daily,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            x: {
              beginAtZero: true
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
      yearlyChart = new Chart(yearlyCtx, {
        type: 'bar',
        data: {
          labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
          datasets: [{
            label: 'Number of Data Entries',
            data: months,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            x: {
              beginAtZero: true
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });

      updateGraphInfo();
    }

    function updateCharts() {
      fetch('/sensor-data')
        .then(response => response.json())
        .then(data => {
          const activityData = data.data;

          // Process data to get the number of entries per hour, day, month, and day of the current month
          hours = Array(24).fill(0);
          days = Array(7).fill(0);
          daily = Array(31).fill(0);
          months = Array(12).fill(0);

          activityData.forEach(item => {
            const [date, time] = item.timestamp.split(', ');
            const [day, month, year] = date.split('/');
            const hour = parseInt(time.split(':')[0], 10);

            // Update hourly data
            hours[hour]++;

            // Update daily data (assuming the first day of the week is Sunday)
            const dayOfWeek = new Date(`${year}-${month}-${day}`).getDay();
            days[dayOfWeek]++;

            // Update daily data for the current month
            if (parseInt(month, 10) === new Date().getMonth() + 1 && parseInt(year, 10) === new Date().getFullYear()) {
              daily[parseInt(day, 10) - 1]++;
            }

            // Update monthly data
            months[parseInt(month, 10) - 1]++;
          });

          // Update the chart data
          hourlyChart.data.datasets[0].data = hours;
          hourlyChart.update();

          weeklyChart.data.datasets[0].data = days;
          weeklyChart.update();

          monthlyChart.data.datasets[0].data = daily;
          monthlyChart.update();

          yearlyChart.data.datasets[0].data = months;
          yearlyChart.update();
        })
        .catch(error => console.error('Error updating charts:', error));
    }

    function updateGraphInfo() {
      document.getElementById('graphTitle').textContent = graphTitles[currentGraph];
      document.getElementById('prevGraph').textContent = `Previous (${graphTitles[(currentGraph - 1 + graphs.length) % graphs.length]})`;
      document.getElementById('nextGraph').textContent = `Next (${graphTitles[(currentGraph + 1) % graphs.length]})`;
    }

    function showGraph(index) {
      graphs.forEach((graph, i) => {
        document.getElementById(graph).style.display = i === index ? 'block' : 'none';
      });
      currentGraph = index;
      updateGraphInfo();
    }

    function prevGraph() {
      showGraph((currentGraph - 1 + graphs.length) % graphs.length);
    }

    function nextGraph() {
      showGraph((currentGraph + 1) % graphs.length);
    }

    // Fetch activity data on page load
    window.onload = fetchActivityData;

    // WebSocket connection to receive real-time updates
    const socket = new WebSocket('ws://' + window.location.host);

    socket.onmessage = function(event) {
      const message = JSON.parse(event.data);
      if (message.type === 'new-data') {
        updateCharts();
      }
    };
  </script>
</body>
</html>